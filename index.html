<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leon H-Arts: –ì–∞–ª–µ—Ä–µ—è –§–∞–Ω—Ñ–∏–∫–æ–≤</title>
<!-- –§–ê–í–ò–ö–û–ù–´: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ Favicon.io -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#ffffff">
    
    <!-- 1. Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React, ReactDOM, Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Firebase CDNs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInAnonymously, 
        signInWithCustomToken, 
        onAuthStateChanged, 
        signInWithEmailAndPassword, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        onSnapshot, 
        collection, 
        query, 
        addDoc, 
        updateDoc, 
        arrayUnion, 
        serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å—ë –≤ window, —á—Ç–æ–±—ã React-—Å–∫—Ä–∏–ø—Ç –º–æ–≥ –æ–±—Ä–∞—â–∞—Ç—å—Å—è ---
    window.initializeApp = initializeApp;
    window.getAuth = getAuth;
    window.signInAnonymously = signInAnonymously;
    window.signInWithCustomToken = signInWithCustomToken;
    window.onAuthStateChanged = onAuthStateChanged;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword; // ‚úÖ –í–ê–ñ–ù–û ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ!
    window.signOut = signOut; // ‚úÖ –¢–æ–∂–µ –Ω—É–∂–Ω–æ –¥–ª—è –≤—ã—Ö–æ–¥–∞
    window.getFirestore = getFirestore;
    window.doc = doc;
    window.onSnapshot = onSnapshot;
    window.collection = collection;
    window.query = query;
    window.addDoc = addDoc;
    window.updateDoc = updateDoc;
    window.arrayUnion = arrayUnion;
    window.serverTimestamp = serverTimestamp;

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞ ---
    if (typeof window.__app_id === 'undefined') window.__app_id = 'default-app-id';
    if (typeof window.__initial_auth_token === 'undefined') window.__initial_auth_token = null;
    if (typeof window.__firebase_config === 'undefined') {
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyBpThMaS36IkmAqUrvk9WpWi0AhOhndhU8",
            authDomain: "leon-h-arts-6b69b.firebaseapp.com",
            projectId: "leon-h-arts-6b69b",
            storageBucket: "leon-h-arts-6b69b.firebasestorage.app",
            messagingSenderId: "162244900947",
            appId: "1:162244900947:web:0d265bc4fe5639380ceea6"
        });
    }
</script>
    
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ–Ω–∞ –∏ —à—Ä–∏—Ñ—Ç–∞ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        /* –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ–º */
        .min-h-screen { min-height: 100vh; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
        .text-with-shadow {
          color: white;
          text-shadow: 
            -1px -1px 0 #000,  
             1px -1px 0 #000,
            -1px 1px 0 #000,
             1px 1px 0 #000,
             0 0 10px rgba(0, 0, 0, 1);
        }

        .fixed-click-zone {
          position: fixed; 
          top: 50%;
          transform: translateY(-50%);
          width: 20%; 
          height: 50%; 
          z-index: 65; 
          cursor: pointer;
          display: flex;
          align-items: center;
          -webkit-tap-highlight-color: transparent; 
        }
        .fixed-click-zone.left {
          left: 0;
          justify-content: flex-start;
        }
        .fixed-click-zone.right {
          right: 0;
          justify-content: flex-end;
        }
        
        .nav-arrow {
          color: white;
          padding: 0;
          cursor: pointer;
          filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.9));
        }
        
        .fixed-click-zone.left .nav-arrow {
          padding-left: 0.5rem; 
        }
        .fixed-click-zone.right .nav-arrow {
          padding-right: 0.5rem; 
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // –ü–æ–ª—É—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ Canvas
        const {useState, useEffect, useCallback, useMemo, useRef , useLayoutEffect} = React;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, onSnapshot, collection, query, addDoc, updateDoc, arrayUnion, serverTimestamp } = window;

        // --- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ React SVG –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–∑–∞–º–µ–Ω–∞ lucide-react) ---
        const Icon = ({ children, size = 24, className = '', ...props }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className={`lucide ${className}`}
                {...props}
            >
                {children}
            </svg>
        );

        const Plus = (props) => (
            <Icon {...props}><line x1="12" x2="12" y1="5" y2="19" /><line x1="5" x2="19" y1="12" y2="12" /></Icon>
        );
        const X = (props) => (
            <Icon {...props}><line x1="18" x2="6" y1="6" y2="18" /><line x1="6" x2="18" y1="6" y2="18" /></Icon>
        );
        const ImageIcon = (props) => (
            <Icon {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></Icon>
        );
        const Loader = (props) => (
            <Icon {...props}><path d="M12 2v4" /><path d="M12 18v4" /><path d="M4.93 4.93l2.83 2.83" /><path d="M16.24 16.24l2.83 2.83" /><path d="M2 12h4" /><path d="M18 12h4" /><path d="M4.93 19.07l2.83-2.83" /><path d="M16.24 7.76l2.83-2.83" /></Icon>
        );
        const Trash2 = (props) => (
            <Icon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></Icon>
        );
        const ArrowUpDown = (props) => (
            <Icon {...props}><path d="m21 16-4 4-4-4" /><path d="M17 20V4" /><path d="m3 8 4-4 4 4" /><path d="M7 4v16" /></Icon>
        );
        const GripVertical = (props) => (
            <Icon {...props}><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></Icon>
        );
        const Save = (props) => (
            <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><path d="M17 21v-8H7v8" /><path d="M7 3v5h8" /></Icon>
        );
        const Pencil = (props) => (
            <Icon {...props}><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></Icon>
        );
        const ChevronLeft = (props) => (
            <Icon {...props}><path d="m15 18-6-6 6-6" /></Icon>
        );
        const ChevronRight = (props) => (
            <Icon {...props}><path d="m9 18 6-6-6-6" /></Icon>
        );
        const Key = (props) => (
            <Icon {...props}><path d="m15.5 13.5 1.7-1.7a2.85 2.85 0 1 1 4 4L19 18l-2 2-4-4 1.5-1.5z" /><path d="M11 20 5 14v-2.5l2.5-2.5h1.7" /><path d="m10 12-1-1" /></Icon>
        );
        const Edit = (props) => (
            <Icon {...props}><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></Icon>
        );
        const AlertTriangle = (props) => (
             <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" x2="12" y1="9" y2="13" /><line x1="12" x2="12" y1="17" y2="17" /></Icon>
        );


        // --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
        const ADMIN_UID = "fqU30jiK7rOobaur0XN2pVY4PMC2";  
        const PUBLIC_COLLECTION_NAME = "fanfic_gallery_albums"; 

        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Canvas
        const firebaseConfig = JSON.parse(window.__firebase_config);
        const appId = window.__app_id;
        const initialAuthToken = window.__initial_auth_token;

        let app = null;
        let db = null;
        let auth = null;
        let configError = null;

        try {
            if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } else {
                throw new Error("API Key Firebase –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω.");
            }
        } catch (e) {
            configError = {
                isCritical: true,
                name: "–û—à–∏–±–∫–∞ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase",
                message: `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase. ${e.message}`
            };
        }

        const TARGET_ROW_HEIGHT = 300; 
        const GALLERY_GAP_PX = 2; 
        const MAX_ROW_HEIGHT_MULTIPLIER = 1.5; 


        // --- –ö–û–ú–ü–û–ù–ï–ù–¢: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
        const ImageModal = ({ image, onClose, onSaveCaption, albumId, onNext, onPrev, isAdmin }) => {
            if (!image || image.type === 'divider') return null;

            const [caption, setCaption] = useState(image.caption || '');
            const [isSaving, setIsSaving] = useState(false);
            const [isEditPanelOpen, setIsEditPanelOpen] = useState(false); 
            
            useEffect(() => {
                setCaption(image.caption || '');
            }, [image.caption]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        onClose();
                    } else if (e.key === 'ArrowRight') {
                        onNext();
                    } else if (e.key === 'ArrowLeft') {
                        onPrev();
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
                return () => {
                    document.removeEventListener('keydown', handleKeyDown);
                };
            }, [onClose, onNext, onPrev]);


            const handleSave = async () => {
                if (!isAdmin) {
                     console.warn("–ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–µ–∑ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
                     return;
                }
                setIsSaving(true);
                await onSaveCaption(albumId, image.timestamp, caption);
                setIsSaving(false);
            };

            return (
                <div 
                    className="fixed inset-0 z-[60] bg-black bg-opacity-90 flex justify-center items-center transition-opacity"
                    onClick={onClose}
                >
                    {/* --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ X –∏ i (–≤–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞) --- */}
                    <div className="absolute top-4 right-4 z-[70] flex space-x-2 p-2">
                        {isAdmin && ( // ! –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                            <button
                                onClick={(e) => { e.stopPropagation(); setIsEditPanelOpen(prev => !prev); }}
                                className={`p-2 text-white transition rounded-full shadow-lg ${
                                    isEditPanelOpen ? 'bg-indigo-600' : 'bg-black bg-opacity-50 hover:bg-opacity-70'
                                }`}
                                title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –ø–æ–¥–ø–∏—Å—å (–¢–æ–ª—å–∫–æ –ê–¥–º–∏–Ω)"
                                aria-label="–û—Ç–∫—Ä—ã—Ç—å/–ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
                            >
                                <Pencil size={24} />
                            </button>
                        )}
                        <button 
                            onClick={onClose} 
                            className="p-2 text-white hover:bg-opacity-70 transition rounded-full bg-black bg-opacity-50"
                            aria-label="–ó–∞–∫—Ä—ã—Ç—å"
                        >
                            <X size={28} />
                        </button>
                    </div>
                    
                    {/* --- –õ–µ–≤–∞—è/–ü—Ä–∞–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è --- */}
                    <div 
                        className="fixed-click-zone left group"
                        onClick={(e) => { e.stopPropagation(); onPrev(); }}
                        title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ (–°—Ç—Ä–µ–ª–∫–∞ –≤–ª–µ–≤–æ)"
                    >
                        <button className="nav-arrow opacity-0 group-hover:opacity-100 transition-opacity">
                            <ChevronLeft size={40} className="w-10 h-10 md:w-12 md:h-12" />
                        </button>
                    </div>
                    <div 
                        className="fixed-click-zone right group"
                        onClick={(e) => { e.stopPropagation(); onNext(); }}
                        title="–°–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ (–°—Ç—Ä–µ–ª–∫–∞ –≤–ø—Ä–∞–≤–æ)"
                    >
                        <button className="nav-arrow opacity-0 group-hover:opacity-100 transition-opacity">
                            <ChevronRight size={40} className="w-10 h-10 md:w-12 md:h-12" />
                        </button>
                    </div>
                    
                    {/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */}
                    <div 
                        className="w-full h-full flex justify-center items-center" 
                        onClick={(e) => e.stopPropagation()} 
                    >
                        <img 
                            src={image.url} 
                            alt={image.caption || "–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ"} 
                            className="max-w-full max-h-screen object-contain" 
                            onError={(e) => { 
                                e.target.onerror = null; 
                                e.target.src = "https://placehold.co/800x600/CCCCCC/333333?text=–û—à–∏–±–∫–∞+–∑–∞–≥—Ä—É–∑–∫–∏"; 
                                e.target.className = "max-w-full max-h-[70vh] object-contain p-4"; 
                            }}
                        />
                    </div>
                    
                    {/* --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥–ø–∏—Å–∏ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è --- */}
                    <div 
                        className="absolute bottom-4 left-4 z-[70] max-w-sm w-full sm:w-auto" 
                        onClick={(e) => e.stopPropagation()} 
                    >
                        <div 
                            className="px-4 py-3 sm:px-6 sm:py-4 bg-transparent text-white"
                        >
                            {image.caption ? (
                                <p className="text-sm font-medium text-with-shadow">{image.caption}</p>
                            ) : (
                                <p className="text-sm font-light text-with-shadow text-gray-300">–ü–æ–¥–ø–∏—Å—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
                            )}
                        </div>

                        {/* –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏ (–¢–æ–ª—å–∫–æ –¥–ª—è –ê–¥–º–∏–Ω–∞) */}
                        {isAdmin && (
                            <div 
                                className={`
                                    bg-white p-4 sm:p-6 rounded-xl shadow-2xl transition-all duration-300 ease-in-out mt-2
                                    ${isEditPanelOpen ? 'block' : 'hidden'}
                                `}
                            >
                                <h3 className="text-lg font-bold text-gray-800 mb-3">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å</h3>
                                    <textarea
                                        value={caption}
                                        onChange={(e) => setCaption(e.target.value)}
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥–ø–∏—Å—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, '–ì–ª–∞–≤–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –ê–Ω–∏–º–µ X'"
                                        className="w-full flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                        maxLength={200}
                                        rows={3}
                                    />
                                <button 
                                    onClick={handleSave}
                                    disabled={isSaving}
                                    className="flex items-center px-4 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition disabled:bg-indigo-400 shadow-md"
                                >
                                    {isSaving ? (
                                        <Loader className="animate-spin h-5 w-5 mr-2" />
                                    ) : (
                                        <Save className="h-5 w-5 mr-2" />
                                    )}
                                    {isSaving ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        // --------------------------------------------------------------------


        // –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const App = () => {

  // === Scroll Position Fix ===
      // --- üß≠ –ù–û–í–û–ï: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ ---
    const scrollPosition = useRef(0);

    const saveScrollPosition = () => {
        scrollPosition.current = window.scrollY || document.documentElement.scrollTop;
    };

  React.useLayoutEffect(() => {
    if (!scrollPosition.current) return;
    requestAnimationFrame(() => {
      setTimeout(() => {
        try {
          window.scrollTo({ top: scrollPosition.current, behavior: 'auto' });
        } catch (e) {
          window.scrollTo(0, scrollPosition.current);
        }
      }, 40);
    });
  }, [selectedAlbum, enlargedImage, isDeleteMode, isReorderMode]);

  React.useEffect(() => {
    if (!scrollPosition.current) return;
    const restore = () => {
      requestAnimationFrame(() => {
        setTimeout(() => {
          try {
            window.scrollTo({ top: scrollPosition.current, behavior: 'auto' });
          } catch (e) {
            window.scrollTo(0, scrollPosition.current);
          }
        }, 60);
      });
    };
    restore();
  }, [albums]);
  // === End Scroll Fix ===

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º '|| false' –¥–ª—è authReady, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ
            const [authReady, setAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [albums, setAlbums] = useState([]);
            const [loading, setLoading] = useState(true);
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º state –æ—à–∏–±–∫–æ–π, –µ—Å–ª–∏ –æ–Ω–∞ –≤–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥–∞
            const [error, setError] = useState(configError || null); 

            // --- –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ---
            const [isAdmin, setIsAdmin] = useState(false);
            const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
            
            // --- –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è ---
            const [isRenameModalOpen, setIsRenameModalOpen] = useState(false);
            const [albumToRename, setAlbumToRename] = useState(null);

            const [currentView, setCurrentView] = useState('home'); 
            const [selectedAlbum, setSelectedAlbum] = useState(null);

            // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const [isDeleteMode, setIsDeleteMode] = useState(false);
            const [isReorderMode, setIsReorderMode] = useState(false);
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            const [isAddAlbumModalOpen, setIsAddAlbumModalOpen] = useState(false);
            const [isAddPhotoModalOpen, setIsAddPhotoModalOpen] = useState(false);
            const [isAddDividerModalOpen, setIsAddDividerModalOpen] = useState(false);
            
            const [enlargedImage, setEnlargedImage] = useState(null); 



    useLayoutEffect(() => {
        if (scrollPosition.current) {
            window.scrollTo({
                top: scrollPosition.current,
                behavior: 'instant' // –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
            });
        }
    }, [selectedAlbum, enlargedImage, isDeleteMode, isReorderMode]);
    // ---------------------------------------------------------------

            
            // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è Drag and Drop
            const dragItemUniqueId = useRef(null); 
            const dragOverItemUniqueId = useRef(null); 

            // --- 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ---
            useEffect(() => {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –¥–∞–ª—å—à–µ –Ω–µ –∏–¥–µ–º
                if (error && error.isCritical) {
                    setAuthReady(true); 
                    setLoading(false);
                    return;
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ localStorage (–ø—Ä–æ—Å—Ç–∞—è —Å–µ—Å—Å–∏—è)
                const adminStatus = localStorage.getItem('isAdmin');
                if (adminStatus === 'true') {
                    setIsAdmin(true);
                }

                const setupFirebase = async () => {
                    if (!auth) { 
                        // –ï—Å–ª–∏ auth –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞), –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∞–µ–º.
                        setAuthReady(true);
                        return;
                    }
                    try {
                        // –í—Å–µ–≥–¥–∞ –ø—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å userId –¥–ª—è —Å–µ—Å—Å–∏–∏
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", e);
                        setError(prev => ({ 
                            ...prev, 
                            name: "–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏", 
                            message: `–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Firebase. (–ö–æ–¥: ${e.code || 'UNKNOWN'}, –°–æ–æ–±—â–µ–Ω–∏–µ: ${e.message})` 
                        }));
                    }
                };

                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        setUserId(null); 
                    }
                    setAuthReady(true);
                });

                setupFirebase();
                return () => unsubscribe();
            }, [error]); 

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ä–µ–∂–∏–º–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ Admin
            useEffect(() => {
                // –°–±—Ä–æ—Å —Ä–µ–∂–∏–º–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ Admin
                if (!isAdmin) {
                    setIsDeleteMode(false);
                    setIsReorderMode(false);
                }
            }, [isAdmin]);

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
            const handleOpenRenameModal = useCallback((album) => {
                if (!isAdmin) return;
                setAlbumToRename(album);
                setIsRenameModalOpen(true);
            }, [isAdmin]);

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
            const handleCloseRenameModal = useCallback(() => {
                setIsRenameModalOpen(false);
                setAlbumToRename(null);
            }, []);

            // --- –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê (Login/Logout) ---
const handleAdminLogin = async (email, password) => {
    if (!auth) {
        alertUser('–û—à–∏–±–∫–∞', 'Firebase Auth –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.');
        return;
    }

    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        if (user.uid === ADMIN_UID) {
            setIsAdmin(true);
            setIsLoginModalOpen(false);
            localStorage.setItem('isAdmin', 'true');
            alertUser('–£—Å–ø–µ—Ö', '–í—Ö–æ–¥ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
        } else {
            await signOut(auth);
            alertUser('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–≠—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
        }

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:", e);
        alertUser('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', `–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Email –∏ –ü–∞—Ä–æ–ª—å. (${e.code})`);
    }
};

            
            // --------------------------------------------

            // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏)
            const handleNavigation = useCallback((direction) => {
                if (!enlargedImage || !selectedAlbum) return;

                const allContent = selectedAlbum.images;
                const images = allContent.filter(item => item.type !== 'divider');

                if (!images || images.length === 0) return;
                
                const currentIndex = images.findIndex(img => img.timestamp === enlargedImage.timestamp);
                if (currentIndex === -1) return;

                let nextIndex;
                if (direction === 'next') {
                    nextIndex = (currentIndex + 1) % images.length;
                } else { // 'prev'
                    nextIndex = (currentIndex - 1 + images.length) % images.length;
                }
                
                const nextImage = images[nextIndex];
                setEnlargedImage(nextImage);
            }, [enlargedImage, selectedAlbum]);

            const handleNextImage = useCallback(() => handleNavigation('next'), [handleNavigation]);
            const handlePrevImage = useCallback(() => handleNavigation('prev'), [handleNavigation]);
            // --------------------------------------------------

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const toggleDeleteMode = useCallback(() => {
                if (!isAdmin) return; // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ Admin
                setIsDeleteMode(prev => !prev);
                if (!isDeleteMode) { 
                    setIsReorderMode(false); // –û—Ç–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ
                }
            }, [isDeleteMode, isAdmin]);

            const toggleReorderMode = useCallback(() => {
                if (!isAdmin) return; // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ Admin
                setIsReorderMode(prev => !prev);
                if (!isReorderMode) { 
                    setIsDeleteMode(false); // –û—Ç–∫–ª—é—á–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
                }
            }, [isReorderMode, isAdmin]);
            // -----------------------------------------

            const handleGoHome = useCallback(() => {
        saveScrollPosition();
                setSelectedAlbum(null);
                setCurrentView('home');
                setIsDeleteMode(false); 
                setIsReorderMode(false);
            }, []); 

            const handleOpenAlbum = useCallback((album) => {
        saveScrollPosition();
                setSelectedAlbum(album);
                setCurrentView('album');
                setIsDeleteMode(false); 
                setIsReorderMode(false);
            }, []); 

            const alertUser = (title, message) => {
                // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞/—Å–æ–æ–±—â–µ–Ω–∏—è
                console.warn(`[–í–ù–ò–ú–ê–ù–ò–ï ${title}]: ${message}`);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º DOM-–º–∞–Ω–∏–ø—É–ª—è—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ window.alert
                if (typeof document !== 'undefined') {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = `
                        <div style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,0.2); z-index:1000; max-width: 90vw; text-align: center; border: 2px solid #ef4444; font-family: sans-serif;">
                            <h4 style="font-weight: bold; color: #ef4444; margin-bottom: 10px;">${title}</h4>
                            <p>${message}</p>
                            <button onclick="this.parentElement.remove()" style="margin-top: 15px; background: #6366f1; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">OK</button>
                        </div>
                    `;
                    document.body.appendChild(tempDiv.firstChild);
                }
            };


            // --- 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–ª—å–±–æ–º–∞—Ö (Real-time Listener) ---
            useEffect(() => {
                // –ß—Ç–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–Ω–∞–ª–∏—á–∏—è userId)
                if (!db || !userId) {
                    if (!userId && authReady) {
                        setLoading(false); 
                    }
                    return; 
                }

                setLoading(true);

                // –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –ø—É—Ç—å
                const collectionPath = `artifacts/${appId}/public/data/${PUBLIC_COLLECTION_NAME}`;
                const q = query(collection(db, collectionPath));

                const unsubscribe = onSnapshot(q, 
                    // 1. Success Callback
                    (querySnapshot) => {
                        const fetchedAlbums = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            const images = Array.isArray(data.images) ? data.images : [];
                            fetchedAlbums.push({ id: doc.id, ...data, images });
                        });
                        
                        fetchedAlbums.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                        setAlbums(fetchedAlbums);
                        setLoading(false);
                        
                        setSelectedAlbum(prevSelectedAlbum => {
                            if (prevSelectedAlbum) {
                                const updatedAlbum = fetchedAlbums.find(a => a.id === prevSelectedAlbum.id);
                                if (updatedAlbum) {
                                    return updatedAlbum; 
                                }
                                // –ï—Å–ª–∏ –∞–ª—å–±–æ–º –±—ã–ª —É–¥–∞–ª–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –ì–ª–∞–≤–Ω—É—é
                                if (currentView === 'album') { 
                                    setCurrentView('home'); 
                                    return null; 
                                }
                            }
                            return prevSelectedAlbum; 
                        });
                    
                    }, 
                    // 2. Error Callback (–ø–µ—Ä–µ–º–µ—â–µ–Ω –∏–∑ setSelectedAlbum)
                    (err) => { 
                        console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Firestore:", err);
                        setError({
                            name: "–û—à–∏–±–∫–∞ –ó–∞–≥—Ä—É–∑–∫–∏ –ê–ª—å–±–æ–º–æ–≤",
                            message: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å. (${err.message})`
                        });
                        setLoading(false);
                    }
                ); // –ö–æ–Ω–µ—Ü –≤—ã–∑–æ–≤–∞ onSnapshot

                return () => unsubscribe();
            }, [userId, authReady, currentView]); // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç userId –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º—ã –∂–¥–µ–º —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞

            // --- 3. CRUD-—Ñ—É–Ω–∫—Ü–∏–∏ (–¢–æ–ª—å–∫–æ –¥–ª—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞) ---
            
            // **–§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–Ø –ê–õ–¨–ë–û–ú–ê**
            const renameAlbum = async (albumId, newName) => {
                if (!isAdmin) {
                    alertUser('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–æ–≤.');
                    return false;
                }
                if (!albumId || !newName.trim() || !db) {
                    console.error("FIREBASE ERROR: Album ID or DB instance is missing for renameAlbum.");
                    alertUser('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∞–ª—å–±–æ–º: –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.');
                    return false;
                }

                try {
                    const collectionPath = `artifacts/${appId}/public/data/${PUBLIC_COLLECTION_NAME}`;
                    const albumRef = doc(db, collectionPath, albumId);
                    
                    await updateDoc(albumRef, {
                        name: newName.trim(),
                    });

                    console.log(`–ê–ª—å–±–æ–º ${albumId} –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ "${newName}"`);
                    handleCloseRenameModal();
                    return true;

                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ –∞–ª—å–±–æ–º–∞:", e);
                    alertUser('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∞–ª—å–±–æ–º.');
                    return false;
                }
            };
            
            // **–û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–î–ü–ò–°–ò –§–û–¢–û–ì–†–ê–§–ò–ò**
            const updatePhotoCaption = async (albumId, photoTimestamp, newCaption) => {
                if (!isAdmin) { // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ Admin
                    alertUser('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–µ–π.');
                    return;
                }
                if (!albumId || !db) {
                    console.error("FIREBASE ERROR: Album ID or DB instance is missing for updatePhotoCaption.");
                    alertUser('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å—å: –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.');
                    return;
                }

                try {
                    const collectionPath = `artifacts/${appId}/public/data/${PUBLIC_COLLECTION_NAME}`;
                    const albumRef = doc(db, collectionPath, albumId);
                    const currentAlbum = albums.find(a => a.id === albumId);
                    
                    if (currentAlbum) {
                        const updatedImages = currentAlbum.images.map(item => {
                            if (item.timestamp === photoTimestamp && item.type !== 'divider') { 
                                return { ...item, caption: newCaption.trim() };
                            }
                            return item;
                        });
                        
                        await updateDoc(albumRef, {
                            images: updatedImages,
                        });

                        setEnlargedImage(prev => {
                            if (prev && prev.timestamp === photoTimestamp) {
                                return { ...prev, caption: newCaption.trim() };
                            }
                            return prev;
                        });
                        
                        console.log(`–ü–æ–¥–ø–∏—Å—å –¥–ª—è —Ñ–æ—Ç–æ ${photoTimestamp} –æ–±–Ω–æ–≤–ª–µ–Ω–∞: "${newCaption}"`);
                    }

                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∏:", e);
                    alertUser('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å—å.');
                }
            };
            
            // **–£–î–ê–õ–ï–ù–ò–ï –≠–õ–ï–ú–ï–ù–¢–ê (–§–û–¢–û –ò–õ–ò –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨)**
            const deletePhoto = async (albumId, itemToDelete) => {
        saveScrollPosition();
                if (!isAdmin) { // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ Admin
                    alertUser('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤.');
                    return;
                }
                if (!albumId || !db) { 
                    console.error("FIREBASE ERROR: Album ID or DB instance is missing for deletePhoto.");
                    alertUser('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç: –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.');
                    return;
                }

                try {
                    const collectionPath = `artifacts/${appId}/public/data/${PUBLIC_COLLECTION_NAME}`;
                    const albumRef = doc(db, collectionPath, albumId);
                    const currentAlbum = albums.find(a => a.id === albumId);
                    
                    if (currentAlbum) {
                        // –§–∏–ª—å—Ç—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É timestamp
                        const updatedImages = currentAlbum.images.filter(item => item.timestamp !== itemToDelete.timestamp);
                        
                        await updateDoc(albumRef, {
                            images: updatedImages,
                        });
                        
                        console.log(`–≠–ª–µ–º–µ–Ω—Ç (—Ç–∏–ø: ${itemToDelete.type || 'photo'}) ${itemToDelete.timestamp} —É–¥–∞–ª–µ–Ω.`);
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª, –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –±—ã–ª —É–≤–µ–ª–∏—á–µ–Ω
                        if (enlargedImage && enlargedImage.timestamp === itemToDelete.timestamp) {
                            saveScrollPosition();
        setEnlargedImage(null);
                        }
                    }

                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞:", e);
                    alertUser('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç.');
                }
            };


            // **–ò–ó–ú–ï–ù–ï–ù–ò–ï –ü–û–†–Ø–î–ö–ê –§–û–¢–û–ì–†–ê–§–ò–ô –ò –†–ê–ó–î–ï–õ–ò–¢–ï–õ–ï–ô (DRAG AND DROP)**
            const handleDragStart = useCallback((e, uniqueId) => {
                if (!isReorderMode || !isAdmin) return; // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ Admin
                dragItemUniqueId.current = uniqueId;
                e.dataTransfer.effectAllowed = "move";
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Drag Image –¥–ª—è –ª—É—á—à–µ–≥–æ UX
                if (e.dataTransfer.setDragImage) {
                     const dragElement = e.target.closest('div').querySelector('img') || e.target.closest('div').querySelector('h2');
                     if(dragElement) e.dataTransfer.setDragImage(dragElement, 10, 10);
                }
            }, [isReorderMode, isAdmin]);

            const handleDragEnter = useCallback((e, uniqueId) => {
                if (!isReorderMode || !isAdmin) return; // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ Admin
                dragOverItemUniqueId.current = uniqueId;
            }, [isReorderMode, isAdmin]);

            const handleDragOver = useCallback((e) => {
                if (!isReorderMode || !isAdmin) return; // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ Admin
                e.preventDefault();
            }, [isReorderMode, isAdmin]);

            const handleDrop = useCallback(async (e) => {
                if (!isAdmin) {
                    alertUser('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞.');
                    dragItemUniqueId.current = null;
                    dragOverItemUniqueId.current = null;
                    return;
                }
                if (!isReorderMode) { 
                    return; 
                }
                if (!selectedAlbum || !db) { 
                    console.error("FIREBASE ERROR: Album or DB instance is missing for handleDrop.");
                    alertUser('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫: –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∞–ª—å–±–æ–º –∏–ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.');
                    dragItemUniqueId.current = null;
                    dragOverItemUniqueId.current = null;
                    return;
                }


                const draggedId = dragItemUniqueId.current;
                const targetId = dragOverItemUniqueId.current;

                if (draggedId === null || targetId === null || draggedId === targetId) {
                    dragItemUniqueId.current = null;
                    dragOverItemUniqueId.current = null;
                    return;
                }

                const collectionPath = `artifacts/${appId}/public/data/${PUBLIC_COLLECTION_NAME}`;
                const albumRef = doc(db, collectionPath, selectedAlbum.id);
                const list = [...selectedAlbum.images];

                const draggedIndex = list.findIndex(item => item.timestamp === draggedId);
                const targetIndex = list.findIndex(item => item.timestamp === targetId);

                if (draggedIndex === -1 || targetIndex === -1) {
                    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç –ø–æ ID –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏.");
                    dragItemUniqueId.current = null;
                    dragOverItemUniqueId.current = null;
                    return;
                }

                const itemToMove = list[draggedIndex];
                list.splice(draggedIndex, 1); 
                list.splice(targetIndex, 0, itemToMove); 

                try {
                    await updateDoc(albumRef, {
                        images: list
                    });
                    console.log("–ü–æ—Ä—è–¥–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≥–∞–ª–µ—Ä–µ–∏ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ Firestore.");
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞:", error);
                    alertUser('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.');
                }
                
                dragItemUniqueId.current = null;
                dragOverItemUniqueId.current = null;
            }, [isReorderMode, isAdmin, selectedAlbum, db]);
            // ------------------------------------------------------------------

            // **–°–û–ó–î–ê–ù–ò–ï –†–ê–ó–î–ï–õ–ò–¢–ï–õ–Ø**
            const addDivider = async (albumId, text) => {
                if (!isAdmin) { // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ Admin
                    alertUser('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π.');
                    return;
                }
                if (!albumId || !text.trim() || !db) { // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ db
                    alertUser('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.');
                    return;
                }

                try {
                    const collectionPath = `artifacts/${appId}/public/data/${PUBLIC_COLLECTION_NAME}`;
                    const albumRef = doc(db, collectionPath, albumId);
                    
                    const newDividerEntry = {
                        type: 'divider',
                        timestamp: Date.now(), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                        text: text.trim(), 
                    };
                    
                    await updateDoc(albumRef, {
                        images: arrayUnion(newDividerEntry) 
                    });

                    setIsAddDividerModalOpen(false);
                    console.log(`–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å "${text}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–ª—å–±–æ–º ${albumId}.`);

                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è:", e);
                    alertUser('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å.');
                }
            };


            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–ª—å–±–æ–º–∞
            const createNewAlbum = async (name) => {
                if (!isAdmin) { // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ Admin
                    alertUser('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–ª—å–±–æ–º–æ–≤.');
                    return;
                }
                if (!name.trim() || !db) { // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ db
                    alertUser('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–ª—å–±–æ–º: –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.');
                    return;
                }

                const albumData = {
                    name: name.trim(),
                    createdAt: serverTimestamp(),
                    images: [], 
                    previewUrl: null 
                };
                try {
                    const collectionPath = `artifacts/${appId}/public/data/${PUBLIC_COLLECTION_NAME}`;
                    await addDoc(collection(db, collectionPath), albumData);
                    setIsAddAlbumModalOpen(false);
                    console.log(`–ê–ª—å–±–æ–º "${name}" —Å–æ–∑–¥–∞–Ω.`);
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–ª—å–±–æ–º–∞:", e);
                    alertUser('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–ª—å–±–æ–º.');
                }
            };

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ –≤ –∞–ª—å–±–æ–º
            const addPhotoLink = async (albumId, url, aspectRatio = 1.0) => {
                if (!isAdmin) { // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ Admin
                    alertUser('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ.');
                    return;
                }
                if (!albumId || !url.trim() || !db) { // ! –ü—Ä–æ–≤–µ—Ä–∫–∞ db
                    alertUser('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ: –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.');
                    return;
                }

                try {
                    const collectionPath = `artifacts/${appId}/public/data/${PUBLIC_COLLECTION_NAME}`;
                    const albumRef = doc(db, collectionPath, albumId);
                    
                    const newImageEntry = {
                        url: url.trim(),
                        type: 'photo',
                        timestamp: Date.now(), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                        aspectRatio: parseFloat(aspectRatio) > 0 ? parseFloat(aspectRatio) : 1.0, 
                        caption: '' 
                    };
                    
                    // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Firestore
                    await updateDoc(albumRef, {
                        images: arrayUnion(newImageEntry)
                    });

                    setIsAddPhotoModalOpen(false);
                    console.log(`–°—Å—ã–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∞–ª—å–±–æ–º ${albumId}.`);

                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Å—ã–ª–∫–∏:", e);
                    alertUser('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Å—ã–ª–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞.');
                }
            };

            // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ---
            const AlbumCard = ({ album }) => {
                // –ù–∞—Ö–æ–¥–∏–º —Å–∞–º–æ–µ –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ª—é–±—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ previewUrl
                const firstPhoto = album.images.find(item => item.type !== 'divider' && item.url);
                const previewUrl = firstPhoto ? firstPhoto.url : null;
                
                const imageCount = album.images.filter(item => item.type !== 'divider').length;
                
                return (
                    <div className="relative">
                        <div 
                            onClick={() => handleOpenAlbum(album)}
                            className="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer overflow-hidden transform hover:scale-[1.02] active:scale-100 duration-200 ease-in-out"
                        >
                            <div className="w-full h-48 bg-gray-200 flex items-center justify-center relative">
                                {previewUrl ? (
                                    <img 
                                        src={previewUrl} 
                                        alt={`–ü—Ä–µ–≤—å—é ${album.name}`} 
                                        className="w-full h-full object-cover"
                                        onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/600x400/CCCCCC/333333?text=–û—à–∏–±–∫–∞+–∑–∞–≥—Ä—É–∑–∫–∏"; }}
                                    />
                                ) : (
                                    <ImageIcon className="w-1/3 h-1/3 text-gray-500" />
                                )}
                            </div>
                            <div className="p-4">
                                <h3 className="font-semibold text-lg text-gray-800 truncate" title={album.name}>{album.name}</h3>
                                <p className="text-sm text-gray-500 mt-1">{imageCount} {imageCount === 1 ? '—Ñ–æ—Ç–æ' : (imageCount > 1 && imageCount < 5 ? '—Ñ–æ—Ç–æ' : '—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π')}</p>
                            </div>
                        </div>
                        
                        {/* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è (–¢–æ–ª—å–∫–æ –¥–ª—è Admin) */}
                        {isAdmin && (
                            <button
                                onClick={(e) => { 
                                    e.stopPropagation(); 
                                    handleOpenRenameModal(album);
                                }}
                                className="absolute top-2 right-2 p-1 bg-white rounded-full shadow-lg text-indigo-600 hover:bg-indigo-50 transition"
                                title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∞–ª—å–±–æ–º"
                            >
                                <Edit className="h-4 w-4" />
                            </button>
                        )}
                    </div>
                );
            };

            const LoadingSpinner = () => (
                <div className="flex justify-center items-center h-full min-h-[300px]">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                    <p className="ml-4 text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
            );
            
            const CalculationSpinner = () => (
                <div className="flex justify-center items-center h-full min-h-[100px] my-8">
                     <Loader className="animate-spin text-indigo-500 mr-3" size={24} />
                    <p className="text-gray-600">–†–∞—Å—á–µ—Ç –º–∞–∫–µ—Ç–∞ –≥–∞–ª–µ—Ä–µ–∏...</p>
                </div>
            );

            const Modal = ({ isOpen, onClose, title, children }) => {
                if (!isOpen) return null;
                
                return (
                    <div className="fixed inset-0 z-50 bg-black bg-opacity-50 flex justify-center items-center p-4" onClick={onClose}>
                        <div 
                            className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-fade-in-up"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div className="flex justify-between items-center border-b pb-3 mb-4">
                                <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                    <X size={24} />
                                </button>
                            </div>
                            {children}
                        </div>
                    </div>
                );
            };
            
            // --- –ú–æ–¥–∞–ª –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞ ---
            const RenameAlbumModal = () => {
                const [newName, setNewName] = useState(albumToRename?.name || '');
                const [isSaving, setIsSaving] = useState(false);

                useEffect(() => {
                    setNewName(albumToRename?.name || '');
                }, [albumToRename]);
                
                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (newName.trim() && albumToRename) {
                        setIsSaving(true);
                        await renameAlbum(albumToRename.id, newName);
                        setIsSaving(false);
                    }
                };

                return (
                    <Modal isOpen={isRenameModalOpen} onClose={handleCloseRenameModal} title={`–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∞–ª—å–±–æ–º "${albumToRename?.name || ''}"`}>
                        <form onSubmit={handleSubmit}>
                            <input
                                type="text"
                                value={newName}
                                onChange={(e) => setNewName(e.target.value)}
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                required
                            />
                            <div className="flex justify-end mt-4 space-x-3">
                                <button type="button" onClick={handleCloseRenameModal} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button 
                                    type="submit" 
                                    disabled={isSaving || !newName.trim() || newName.trim() === albumToRename?.name}
                                    className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md disabled:bg-indigo-400"
                                >
                                    {isSaving ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
                                </button>
                            </div>
                        </form>
                    </Modal>
                );
            };
            // ----------------------------------------------
            
            // --- –ú–æ–¥–∞–ª –¥–ª—è –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ---
const AdminLoginModal = () => {

    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        handleAdminLogin(email, password); // —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ app.jsx
        setPassword('');
    };

    return (
        <Modal
            isOpen={isLoginModalOpen}
            onClose={() => setIsLoginModalOpen(false)}
            title="–í—Ö–æ–¥ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
        >
            <form onSubmit={handleSubmit} className="space-y-4">

                {/* –ü–æ–ª–µ –¥–ª—è email */}
                <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                    required
                />

                {/* –ü–æ–ª–µ –¥–ª—è –ø–∞—Ä–æ–ª—è */}
                <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                    required
                />

                <div className="flex justify-end mt-4 space-x-3">
                    <button
                        type="button"
                        onClick={() => setIsLoginModalOpen(false)}
                        className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                    >
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button
                        type="submit"
                        className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md"
                    >
                        –í–æ–π—Ç–∏
                    </button>
                </div>
            </form>
        </Modal>
    );
};

            // ----------------------------------------------


            const AddAlbumModal = () => {
                const [albumName, setAlbumName] = useState('');
                
                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (albumName.trim()) {
                        createNewAlbum(albumName);
                    }
                };

                return (
                    <Modal isOpen={isAddAlbumModalOpen} onClose={() => setIsAddAlbumModalOpen(false)} title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º">
                        <form onSubmit={handleSubmit}>
                            <input
                                type="text"
                                value={albumName}
                                onChange={(e) => setAlbumName(e.target.value)}
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                required
                            />
                            <div className="flex justify-end mt-4 space-x-3">
                                <button type="button" onClick={() => setIsAddAlbumModalOpen(false)} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md">
                                    –°–æ–∑–¥–∞—Ç—å
                                </button>
                            </div>
                        </form>
                    </Modal>
                );
            };

            const AddDividerModal = () => {
                const [dividerText, setDividerText] = useState('');
                
                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (dividerText.trim() && selectedAlbum) {
                        addDivider(selectedAlbum.id, dividerText);
                        setDividerText('');
                    }
                };

                return (
                    <Modal isOpen={isAddDividerModalOpen} onClose={() => setIsAddDividerModalOpen(false)} title="–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å">
                        <form onSubmit={handleSubmit}>
                            <label className="block text-sm font-medium text-gray-700 mb-1">–¢–µ–∫—Å—Ç –≥–ª–∞–≤—ã/—Ä–∞–∑–¥–µ–ª–∞</label>
                            <input
                                type="text"
                                value={dividerText}
                                onChange={(e) => setDividerText(e.target.value)}
                                placeholder="–ì–ª–∞–≤–∞ ..."
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                required
                            />
                            <div className="flex justify-end mt-4 space-x-3">
                                <button type="button" onClick={() => setIsAddDividerModalOpen(false)} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button type="submit" className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md">
                                    –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                                </button>
                            </div>
                        </form>
                    </Modal>
                );
            };


            const AddPhotoModal = () => {
                const [photoUrl, setPhotoUrl] = useState('');
                const [aspectRatio, setAspectRatio] = useState('1.0');
                const [selectedAlbumId, setSelectedAlbumId] = useState('');
                const [previewImage, setPreviewImage] = useState(null);

                useEffect(() => {
                    if (albums.length > 0 && !selectedAlbumId) {
                        if (currentView === 'album' && selectedAlbum) {
                            setSelectedAlbumId(selectedAlbum.id);
                        } else {
                            setSelectedAlbumId(albums[0].id);
                        }
                    }
                }, [albums, selectedAlbumId, currentView, selectedAlbum]);

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (selectedAlbumId && photoUrl.trim()) {
                        const ratio = parseFloat(aspectRatio.replace(',', '.')); 

                        if (isNaN(ratio) || ratio <= 0) {
                             alertUser('–û—à–∏–±–∫–∞', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω. –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0.');
                             return;
                        }
                        
                        addPhotoLink(selectedAlbumId, photoUrl, ratio);
                        setPhotoUrl('');
                        setAspectRatio('1.0');
                        setPreviewImage(null);
                    }
                };

                const handleUrlChange = (e) => {
                    const url = e.target.value;
                    setPhotoUrl(url);
                    setPreviewImage(null); 
                    if (url.startsWith('http')) {
                        setPreviewImage(url);
                    }
                };
// --- –ê–í–¢–û-–†–ê–°–ß–Å–¢ –ü–†–û–ü–û–†–¶–ò–ô ---
useEffect(() => {
    if (!previewImage) return;

    const img = new Image();
    img.onload = () => {
        if (img.naturalWidth && img.naturalHeight) {
            const ratio = (img.naturalWidth / img.naturalHeight).toFixed(2);
            setAspectRatio(ratio);
            console.log(`–ê–≤—Ç–æ-–ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã: ${ratio}`);
        }
    };
    img.onerror = () => {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
    };
    img.src = previewImage;
}, [previewImage]);

                return (
                    <Modal isOpen={isAddPhotoModalOpen} onClose={() => setIsAddPhotoModalOpen(false)} title="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –ø–æ —Å—Å—ã–ª–∫–µ">
                        <form onSubmit={handleSubmit}>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (Imgur, GitHub –∏ —Ç.–¥.)</label>
                                    <input
                                        type="url"
                                        value={photoUrl}
                                        onChange={handleUrlChange}
                                        placeholder="https://i.imgur.com/your-image.jpg"
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                        required
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω (–®–∏—Ä–∏–Ω–∞/–í—ã—Å–æ—Ç–∞)</label>
                                    <input
                                        type="text"
                                        value={aspectRatio}
                                        onChange={(e) => setAspectRatio(e.target.value)}
                                        placeholder="1.0 (–¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–∞) –∏–ª–∏ 1.5 (–¥–ª—è 3:2)"
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                        required
                                    />
                                    <p className="text-xs text-gray-500 mt-1">
                                        –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ: 1.0 (–∫–≤–∞–¥—Ä–∞—Ç), 1.77 (16:9), 0.56 (9:16). 
                                    </p>
                                </div>
                                
                                {previewImage && (
                                    <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                        <p className="text-xs text-gray-600 mb-2">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</p>
                                        <img 
                                            src={previewImage} 
                                            alt="–ü—Ä–µ–≤—å—é" 
                                            className="w-full max-h-32 object-contain rounded"
                                            onError={(e) => { e.target.onerror = null; setPreviewImage(null); console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–≤—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É."); }}
                                        />
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">–í—ã–±—Ä–∞—Ç—å –∞–ª—å–±–æ–º</label>
                                    <select
                                        value={selectedAlbumId}
                                        onChange={(e) => setSelectedAlbumId(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white"
                                        required
                                    >
                                        {albums.map(album => (
                                            <option key={album.id} value={album.id}>{album.name}</option>
                                        ))}
                                    </select>
                                    {albums.length === 0 && <p className="text-red-500 text-xs mt-1">–°–æ–∑–¥–∞–π—Ç–µ –∞–ª—å–±–æ–º, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ.</p>}
                                </div>
                            </div>

                            <div className="flex justify-end mt-6 space-x-3">
                                <button type="button" onClick={() => setIsAddPhotoModalOpen(false)} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button 
                                    type="submit" 
                                    disabled={albums.length === 0 || !aspectRatio || isNaN(parseFloat(aspectRatio.replace(',', '.'))) || parseFloat(aspectRatio.replace(',', '.')) <= 0} 
                                    className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-md disabled:bg-indigo-400"
                                >
                                    –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                                </button>
                            </div>
                        </form>
                    </Modal>
                );
            };
            
            // –í–∏–¥: –°–µ—Ç–∫–∞ —Ñ–æ—Ç–æ –≤ –∞–ª—å–±–æ–º–µ (Justified Gallery)
            const AlbumPhotoView = () => {
                if (!selectedAlbum) return <HomeView />;

                const albumRef = useRef(null);
                const [containerWidth, setContainerWidth] = useState(0);

                const updateWidth = useCallback(() => {
                    if (albumRef.current) {
                        setContainerWidth(albumRef.current.clientWidth);
                    }
                }, []); 

                useEffect(() => {
                    updateWidth();
                    
                    const resizeObserver = new ResizeObserver(updateWidth);
                    if (albumRef.current) {
                        resizeObserver.observe(albumRef.current);
                    }
                    
                    return () => {
                        resizeObserver.disconnect(); 
                    };
                }, [updateWidth]); 

                const allContent = selectedAlbum.images;

                const justifiedRows = useMemo(() => {
                    if (containerWidth <= 0) return [];
                    
                    const rows = [];
                    let currentRow = [];
                    let currentRowTotalAspect = 0; 
                    
                    const calculateGapWidth = (count) => (count - 1) * GALLERY_GAP_PX;

                    const finalizePhotoRow = (row, isLastRow = false) => {
                        if (row.length === 0) return;

                        const rowGapWidth = calculateGapWidth(row.length);
                        const rowContainerWidth = containerWidth - rowGapWidth;
                        const totalAspect = row.reduce((sum, img) => sum + img.aspectRatio, 0);

                        let finalRowHeight = rowContainerWidth / totalAspect;
                        
                        if (!isLastRow) {
                            const maxHeight = TARGET_ROW_HEIGHT * MAX_ROW_HEIGHT_MULTIPLIER;
                            if (finalRowHeight > maxHeight) {
                                finalRowHeight = maxHeight; 
                            }
                        } else {
                            if (finalRowHeight > TARGET_ROW_HEIGHT * 1.2) {
                                finalRowHeight = TARGET_ROW_HEIGHT;
                            }
                        }
                        
                        const finalRow = row.map(img => ({
                            ...img,
                            height: finalRowHeight,
                            width: img.aspectRatio * finalRowHeight,
                        }));
                        
                        rows.push({ type: 'photoRow', content: finalRow, uniqueId: rows.length });
                    };

                    for (const item of allContent) {
                        if (item.type === 'divider') {
                            if (currentRow.length > 0) {
                                finalizePhotoRow(currentRow);
                                currentRow = [];
                                currentRowTotalAspect = 0;
                            }
                            rows.push({ type: 'dividerRow', content: item, uniqueId: item.timestamp });

                        } else if (item.aspectRatio > 0 && item.url) {
                            const potentialAspect = currentRowTotalAspect + item.aspectRatio;
                            const rowCount = currentRow.length + 1;
                            const potentialRowHeight = (containerWidth - calculateGapWidth(rowCount)) / potentialAspect;

                            // –£—Å–ª–æ–≤–∏–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏: –µ—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–π (—Ç.–µ. —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ)
                            const shouldStartNewRow = currentRow.length > 0 && potentialRowHeight < TARGET_ROW_HEIGHT * 0.9; 

                            if (shouldStartNewRow) {
                                finalizePhotoRow(currentRow);

                                currentRow = [item];
                                currentRowTotalAspect = item.aspectRatio;
                            } else {
                                currentRow.push(item);
                                currentRowTotalAspect = potentialAspect;
                            }
                        }
                    }
                    
                    if (currentRow.length > 0) {
                        finalizePhotoRow(currentRow, true);
                    }
                    
                    return rows;

                }, [allContent, containerWidth]);


                const isDraggingCurrent = (uniqueId) => isReorderMode && dragItemUniqueId.current === uniqueId;
                const isDragOverTarget = (uniqueId) => isReorderMode && dragOverItemUniqueId.current === uniqueId && dragItemUniqueId.current !== uniqueId;


                return (
                    <div className="py-6 md:py-10 pt-4 md:pt-6"> 
                        <div 
                            ref={albumRef}
                            className="w-full" 
                            onDrop={isReorderMode && isAdmin ? handleDrop : undefined} // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω
                            onDragOver={isReorderMode && isAdmin ? handleDragOver : undefined} // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω
                        >
                            {containerWidth === 0 && allContent.length > 0 && <CalculationSpinner />}
                            
                            {/* –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ Justified Gallery / –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π */}
                            {(containerWidth > 0 && justifiedRows.length > 0) && justifiedRows.map((rowWrapper) => {
                                const key = rowWrapper.uniqueId; 

                                if (rowWrapper.type === 'dividerRow') {
                                    const divider = rowWrapper.content;
                                    return (
                                        <div 
                                            key={key} 
                                            className={`
                                                w-full my-8 flex items-center justify-center relative 
                                                ${isReorderMode ? 'cursor-grab py-2' : ''}
                                                ${isDraggingCurrent(divider.timestamp) ? 'opacity-50 border-2 border-indigo-500 scale-[0.98]' : ''}
                                                ${isDragOverTarget(divider.timestamp) ? 'border-2 border-dashed border-green-500' : ''}
                                            `}
                                            draggable={isReorderMode && isAdmin} // ! –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è Admin
                                            onDragStart={isReorderMode && isAdmin ? (e) => handleDragStart(e, divider.timestamp) : undefined}
                                            onDragEnter={isReorderMode && isAdmin ? (e) => handleDragEnter(e, divider.timestamp) : undefined}
                                        >
                                            <div className="w-full h-px bg-gray-300 mx-4 hidden sm:block"></div>
                                            <h2 className="text-2xl font-extrabold text-gray-800 px-4 py-2 border-b-2 border-indigo-600 inline-block text-center whitespace-nowrap">
                                                {divider.text}
                                            </h2>
                                            <div className="w-full h-px bg-gray-300 mx-4 hidden sm:block"></div>
                                            
                                            {/* –ò–ù–î–ò–ö–ê–¢–û–† –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø (–¢–æ–ª—å–∫–æ –¥–ª—è Admin) */}
                                            {isReorderMode && isAdmin && (
                                                <div 
                                                    className="absolute top-1/2 left-2 transform -translate-y-1/2 bg-black/50 text-white p-1 rounded-full opacity-100 transition duration-200 cursor-grab z-20"
                                                    title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å"
                                                >
                                                    <GripVertical className="h-4 w-4" />
                                                </div>
                                            )}
                                             {/* –ö–ù–û–ü–ö–ê –£–î–ê–õ–ï–ù–ò–Ø –†–ê–ó–î–ï–õ–ò–¢–ï–õ–Ø (–¢–æ–ª—å–∫–æ –¥–ª—è Admin) */}
                                             {isDeleteMode && isAdmin && (
                                                <button
                                                    onClick={(e) => { 
                                                        e.stopPropagation(); 
                                                        deletePhoto(selectedAlbum.id, divider);
                                                    }}
                                                    className="absolute top-1/2 right-2 transform -translate-y-1/2 bg-red-600 text-white p-1.5 rounded-full opacity-100 transition duration-200 hover:bg-red-700 shadow-lg z-20"
                                                    title="–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å"
                                                >
                                                    <Trash2 className="h-4 w-4" />
                                                </button>
                                            )}
                                        </div>
                                    );
                                }

                                // --- –†–ï–ù–î–ï–†: –†–Ø–î –§–û–¢–û–ì–†–ê–§–ò–ô ---
                                const row = rowWrapper.content;
                                return (
                                    <div
                                        key={key}
                                        className="flex overflow-hidden"
                                        style={{ marginBottom: `${GALLERY_GAP_PX}px` }} 
                                    >
                                        {row.map((image, imageIndex) => {
                                            const uniqueId = image.timestamp; 

                                            return (
                                                <div 
                                                    key={uniqueId} 
                                                    onClick={!isDeleteMode && !isReorderMode ? () => setEnlargedImage(image) : undefined}
                                                    
                                                    // –ê—Ç—Ä–∏–±—É—Ç—ã Drag and Drop (–¢–æ–ª—å–∫–æ –¥–ª—è Admin)
                                                    draggable={isReorderMode && isAdmin}
                                                    onDragStart={isReorderMode && isAdmin ? (e) => handleDragStart(e, uniqueId) : undefined}
                                                    onDragEnter={isReorderMode && isAdmin ? (e) => handleDragEnter(e, uniqueId) : undefined}

                                                    className={`
                                                        cursor-pointer relative overflow-hidden bg-gray-200 transition duration-150 shadow-md 
                                                        ${isReorderMode && isAdmin ? 'cursor-grab active:cursor-grabbing' : 'hover:opacity-90'}
                                                        ${isDraggingCurrent(uniqueId) ? 'opacity-50 border-4 border-indigo-500 scale-95' : ''}
                                                        ${isDragOverTarget(uniqueId) ? 'border-4 border-dashed border-green-500' : ''}
                                                    `}
                                                    style={{
                                                        height: `${image.height}px`,
                                                        width: `${image.width}px`,
                                                        marginRight: imageIndex < row.length - 1 ? `${GALLERY_GAP_PX}px` : '0',
                                                    }}
                                                >
                                                    <img 
                                                        src={image.url} 
                                                        alt={image.caption || `–§–æ—Ç–æ ${key}-${imageIndex + 1}`} 
                                                        className="w-full h-full object-cover" 
                                                        style={{ width: '100%', height: '100%' }}
                                                        onError={(e) => { 
                                                            e.target.onerror = null; 
                                                            e.target.src = "https://placehold.co/400x400/CCCCCC/333333?text=URL+–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"; 
                                                        }}
                                                    />
                                                    
                                                    {/* –ö–ù–û–ü–ö–ê –£–î–ê–õ–ï–ù–ò–Ø (–¢–æ–ª—å–∫–æ –¥–ª—è Admin) */}
                                                    {isDeleteMode && isAdmin && (
                                                        <button
                                                            onClick={(e) => { 
                                                                e.stopPropagation();
                                                                deletePhoto(selectedAlbum.id, image);
                                                            }}
                                                            className="absolute top-2 right-2 bg-red-600 text-white p-1.5 rounded-full opacity-100 transition duration-200 hover:bg-red-700 shadow-lg z-20"
                                                            title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ"
                                                        >
                                                            <Trash2 className="h-4 w-4" />
                                                        </button>
                                                    )}

                                                    {/* –ò–ù–î–ò–ö–ê–¢–û–† –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø (–¢–æ–ª—å–∫–æ –¥–ª—è Admin) */}
                                                    {isReorderMode && isAdmin && (
                                                        <div 
                                                            className="absolute top-1/2 left-2 transform -translate-y-1/2 bg-black/50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition duration-200 cursor-grab z-20"
                                                            title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å"
                                                        >
                                                            <GripVertical className="h-4 w-4" />
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                );
                            })}

                        </div>


                        {allContent.length === 0 && (
                             <div className="mx-4 sm:mx-6 lg:mx-8 text-center py-20 bg-gray-50 rounded-xl mt-8 border border-dashed border-gray-300"> 
                                <ImageIcon className="w-12 h-12 text-gray-400 mx-auto" />
                                <h3 className="mt-2 text-lg font-medium text-gray-900">–≠—Ç–æ—Ç –∞–ª—å–±–æ–º –ø—É—Å—Ç</h3>
                                {isAdmin && (
                                    <p className="mt-1 text-sm text-gray-500">
                                        –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫–∏ –≤–≤–µ—Ä—Ö—É.
                                    </p>
                                )}
                                {!isAdmin && (
                                    <p className="mt-1 text-sm text-gray-500">
                                        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∫–æ—Ä–æ –¥–æ–±–∞–≤–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç.
                                    </p>
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            // --- –í–∏–¥: –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–°–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤) ---
            const HomeView = () => (
                <div className="px-4 sm:px-6 lg:px-8 py-8">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-8 border-b pb-2">–í—Å–µ –∞–ª—å–±–æ–º—ã</h2>
                    
                    {albums.length === 0 ? (
                        <div className="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300">
                            <ImageIcon className="w-12 h-12 text-gray-400 mx-auto" />
                            <h3 className="mt-2 text-lg font-medium text-gray-900">–ê–ª—å–±–æ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                            {isAdmin && (
                                <p className="mt-1 text-sm text-gray-500">
                                    –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∞–ª—å–±–æ–º.
                                </p>
                            )}
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            {albums.map(album => (
                                <AlbumCard key={album.id} album={album} />
                            ))}
                        </div>
                    )}
                </div>
            );
            // --- –û–±—â–∏–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ ---

            // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
            if (error && error.isCritical) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
            ¬† ¬† ¬† ¬† ¬† ¬† <div className="bg-red-100 border-l-4 border-red-500 p-6 rounded-xl text-red-900 shadow-2xl max-w-lg">
            ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <h1 className="text-2xl font-bold mb-3">{error.name}</h1>
            ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <p className="text-red-800 whitespace-pre-wrap">{error.message}</p>
            ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <p className="mt-4 text-sm font-semibold">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Firebase –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.</p>
            ¬† ¬† ¬† ¬† ¬† ¬† </div>
            ¬† ¬† ¬† ¬† </div>
                );
            }
            
            if (!authReady || (loading && !error)) {
                return <LoadingSpinner />;
            }

            if (error && !error.isCritical) {
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–ª—è –Ω–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–ª—å–±–æ–º –∏–ª–∏ –æ—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
                return (
                    <div className="p-8 text-center text-red-600 bg-red-100 rounded-xl m-10">
                        <strong>{error.name || '–û—à–∏–±–∫–∞'}:</strong> {error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'}
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 font-sans">
                    
                    {/* Header / Top Bar */}
                    <header className="bg-white shadow-md sticky top-0 z-10">
                        <div className="px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                            
                            {/* –õ–ï–í–ê–Ø –ß–ê–°–¢–¨: –õ–æ–≥–æ—Ç–∏–ø + –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∞–ª—å–±–æ–º—É */}
                            <div className="flex items-center">
                                <div className="flex items-center">
                                    <h1 className="text-3xl font-bold flex items-center">
  <img src="/favicon-32x32.png" alt="–õ–æ–≥–æ—Ç–∏–ø" className="inline-block w-6 h-6 mr-2 align-middle" />
  <span className="text-xl font-bold text-gray-800">Leon H-Arts</span>
</h1>
                                </div>

                                {currentView === 'album' && selectedAlbum && (
                                    <div className="ml-4 pl-4 border-l border-gray-200 flex items-center flex-wrap">
                                        <button 
                                            onClick={handleGoHome} 
                                            className="text-indigo-600 hover:text-indigo-800 transition text-sm font-medium"
                                            aria-label="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∞–ª—å–±–æ–º–∞–º"
                                        >
                                            –ê–ª—å–±–æ–º—ã
                                        </button>
                                        <span className="text-gray-500 mx-2 text-sm">/</span>
                                        <span className="text-gray-900 font-semibold text-sm truncate max-w-[150px] sm:max-w-xs" title={selectedAlbum.name}>{selectedAlbum.name}</span>
                                        <span className="text-gray-500 ml-3 text-xs hidden sm:inline-block">({selectedAlbum.images.filter(i => i.type !== 'divider').length} —Ñ–æ—Ç–æ)</span>
                                    </div>
                                )}
                            </div>
                            
                            {/* –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨: –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                            <div className="flex items-center space-x-3">

                                {/* --- –ö–ù–û–ü–ö–ò –†–ï–ñ–ò–ú–û–í –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (–¢–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∞–ª—å–±–æ–º–∞ –ò –¥–ª—è Admin) --- */}
                                {isAdmin && currentView === 'album' && selectedAlbum && (
                                    <>
                                        <button
                                            onClick={toggleDeleteMode}
                                            className={`p-2 rounded-full transition shadow-md ${isDeleteMode 
                                                ? 'bg-red-500 text-white hover:bg-red-600' 
                                                : 'bg-white text-gray-700 hover:bg-gray-100'}`}
                                            title="–í–∫–ª—é—á–∏—Ç—å/–í—ã–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è"
                                            aria-pressed={isDeleteMode}
                                        >
                                            <Trash2 className="h-5 w-5" />
                                        </button>

                                        <button
                                            onClick={toggleReorderMode}
                                            className={`p-2 rounded-full transition shadow-md ${isReorderMode 
                                                ? 'bg-indigo-500 text-white hover:bg-indigo-600' 
                                                : 'bg-white text-gray-700 hover:bg-gray-100'}`}
                                            title="–í–∫–ª—é—á–∏—Ç—å/–í—ã–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞"
                                            aria-pressed={isReorderMode}
                                        >
                                            <ArrowUpDown className="h-5 w-5" />
                                        </button>
                                        
                                        <button
                                            onClick={() => setIsAddDividerModalOpen(true)}
                                            className="p-2 border border-gray-300 text-sm font-medium rounded-full text-gray-700 bg-white hover:bg-gray-100 transition shadow-sm"
                                            title="–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (–ì–ª–∞–≤–∞)"
                                            disabled={isDeleteMode || isReorderMode}
                                        >
                                            <Pencil className="h-5 w-5" />
                                        </button>
                                    </>
                                )}


                                {/* --- –ö–ù–û–ü–ö–ò –î–û–ë–ê–í–õ–ï–ù–ò–Ø (–¢–æ–ª—å–∫–æ –¥–ª—è Admin) --- */}
                                {isAdmin && (
                                    <>
                                        <button
                                            onClick={() => setIsAddPhotoModalOpen(true)}
                                            className="flex items-center p-2 border border-gray-300 text-sm font-medium rounded-full shadow-sm text-gray-700 bg-white hover:bg-gray-100 transition"
                                            disabled={isDeleteMode || isReorderMode}
                                            title="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ"
                                        >
                                            <ImageIcon className="h-5 w-5" />
                                        </button>
                                        <button
                                            onClick={() => setIsAddAlbumModalOpen(true)}
                                            className="flex items-center p-2 border border-gray-300 text-sm font-medium rounded-full text-gray-700 bg-white hover:bg-gray-100 transition shadow-sm"
                                            title="–°–æ–∑–¥–∞—Ç—å –∞–ª—å–±–æ–º"
                                        >
                                            <Plus className="h-5 w-5" />
                                        </button>
                                    </>
                                )}
                                
                                {/* --- –ö–ù–û–ü–ö–ê –ê–î–ú–ò–ù–ê (Login/Logout) --- */}
                                {!isAdmin && (
                                    <button
                                        onClick={() => setIsLoginModalOpen(true)}
                                        className="flex items-center px-4 py-2 border border-indigo-300 text-sm font-medium rounded-full text-indigo-700 bg-indigo-100 hover:bg-indigo-200 transition shadow-sm"
                                        title="–í–æ–π—Ç–∏ –∫–∞–∫ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
                                    >
                                        <Key className="h-5 w-5 mr-2" />
                                        –ê–¥–º–∏–Ω –í—Ö–æ–¥
                                    </button>
                                )}
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="pb-12">
                        {currentView === 'home' ? <HomeView /> : <AlbumPhotoView />}
                    </main>

                    {/* Modals */}
                    <AdminLoginModal /> 
                    <RenameAlbumModal />
                    <AddAlbumModal />
                    <AddPhotoModal />
                    <AddDividerModal /> 
                    
                    {/* –ú–æ–¥–∞–ª: –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–∏ */}
                    <ImageModal 
                        image={enlargedImage} 
                        onClose={() => setEnlargedImage(null)} 
                        onSaveCaption={updatePhotoCaption}
                        albumId={selectedAlbum?.id} 
                        onNext={handleNextImage}
                        onPrev={handlePrevImage}
                        isAdmin={isAdmin} 
                    />

                </div>
            );
        };
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const container = document.getElementById('root');
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º createRoot –¥–ª—è React 18+
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
